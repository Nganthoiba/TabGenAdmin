<?php
session_start();
include('server_IP.php');
include('connect_db.php');
//$conn = new PDO("mysql:host=188.166.210.24;dbname=mattermost_test",'mmuser','mostest');
if(isset($_SESSION['user_details'])){
	$user_details = json_decode($_SESSION['user_details']);
	if(!empty($_POST)){
		$role_name=$_POST['role_name'];
		$no_of_tabs=(int)$_POST['no_of_tabs'];
		$createdBy = $user_details->username;
		
		try{	
			if($conn){
				$existing_no_of_tabs = existingNoOfTabs($role_name,$conn);
				if($existing_no_of_tabs==0){
					for($i=1;$i<=$no_of_tabs;$i++){
						$tab_name = $role_name."Tab".$i;
						$id = randId(26);
						$query="INSERT INTO Tab(Id,Name,RoleName,CreatedBy)values('$id','$tab_name','$role_name','$createdBy')";
						try{
							$result = $conn->query($query);
							if($result){
								echo $tab_name." Saved successfully. ";
							}
							else echo $tab_name." Could not be saved. ";
						}
						catch(Exception $e){
							echo "Failed to save data: ".$e->getMessage();
						}
					}
				}
				else if($existing_no_of_tabs < $no_of_tabs){
					for($i=$existing_no_of_tabs+1; $i<=$no_of_tabs; $i++){
						$tab_name = $role_name."Tab".$i;
						$id = randId(26);
						$query="INSERT INTO Tab(Id,Name,RoleName,CreatedBy)values('$id','$tab_name','$role_name','$createdBy')";
						try{
							$result = $conn->query($query);
							if($result){
								echo $tab_name." Saved successfully. ";
							}
							else echo $tab_name." Could not be saved. ";
						}
						catch(Exception $e){
							echo "Failed to save data: ".$e->getMessage();
						}
					}
				}
				else{
					echo $no_of_tabs." Tab(s) already created..";
				}
				
			}
		}catch(PDOException $e){
			echo "Failed to save: ".$e->getMessage();
		}		
	}
	else{
		echo "No perameter passed..!";
	}
}
else echo "Session expired, login again.";
?>
<?php
	function randId($length){
		$id = md5(uniqid());
		$char = str_shuffle($id);
		for($i = 0, $rand = '', $l = strlen($char) - 1; $i < $length; $i ++) {
			$rand .= $char{mt_rand(0, $l)};
		}
		return $rand;
	}
	/* function to find number of tabs of a particular role*/
	function existingNoOfTabs($roleName,$conn){
		$res = $conn->query("SELECT COUNT(*) AS NO_OF_TABS FROM Tab where RoleName='$roleName'");
		$row = $res->fetch(PDO::FETCH_ASSOC);
		$no_of_tabs = (int)$row['NO_OF_TABS'];
		return $no_of_tabs;
	}
?>
